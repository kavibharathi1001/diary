<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diarytoon - AI Wellness Journal</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-purple: #bc13fe;
            --neon-blue: #00d2ff;
            --deep-space: #050816;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--deep-space);
            background-image: 
                radial-gradient(circle at 20% 20%, rgba(188, 19, 254, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 80% 80%, rgba(0, 210, 255, 0.15) 0%, transparent 40%);
            color: #e2e8f0;
            background-attachment: fixed;
        }
        .scroll-container {
            max-height: 70vh;
            overflow-y: auto;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.8);
        }
        .tab-active {
            color: #fff;
            text-shadow: 0 0 10px var(--neon-blue), 0 0 20px var(--neon-blue);
            border-bottom: 3px solid var(--neon-blue);
        }
        .nav-item {
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-size: 0.75rem;
        }
        .nav-item:hover {
            color: var(--neon-blue);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        input, textarea {
            background: rgba(255, 255, 255, 0.05) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: white !important;
        }
        input:focus, textarea:focus {
            border-color: var(--neon-blue) !important;
            box-shadow: 0 0 10px rgba(0, 210, 255, 0.3) !important;
            outline: none;
        }
        .btn-primary {
            background: linear-gradient(90deg, #6366f1, #a855f7);
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.4);
            transition: all 0.3s;
        }
        .btn-primary:hover {
            box-shadow: 0 0 30px rgba(168, 85, 247, 0.6);
            transform: translateY(-2px);
        }
        .sentiment-badge {
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
        }
        .sentiment-happy { background: rgba(34, 197, 94, 0.2); color: #4ade80; border: 1px solid #22c55e; }
        .sentiment-sad { background: rgba(239, 68, 68, 0.2); color: #f87171; border: 1px solid #ef4444; }
        .sentiment-neutral { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid #3b82f6; }
        
        /* New Share/Download Button Style */
        .action-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.2s;
        }
        .action-btn:hover {
            background: rgba(0, 210, 255, 0.2);
            border-color: var(--neon-blue);
        }
    </style>
</head>
<body class="min-h-screen pb-20 md:pb-8">

    <!-- Top Navigation Bar -->
    <nav class="bg-black/40 backdrop-blur-md sticky top-0 z-50 border-b border-white/10">
        <div class="max-w-6xl mx-auto px-4 flex items-center justify-between h-16">
            <div class="flex-shrink-0 flex items-center">
                <span class="text-2xl font-black italic tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-cyan-400">
                    DIARYTOON
                </span>
            </div>
            <div class="hidden md:flex space-x-8 text-gray-400 font-bold">
                <div onclick="switchTab('home')" id="tab-home" class="nav-item tab-active py-5">Home</div>
                <div onclick="switchTab('diary')" id="tab-diary" class="nav-item py-5">Diary</div>
                <div onclick="switchTab('social')" id="tab-social" class="nav-item py-5">Social</div>
                <div onclick="switchTab('decode')" id="tab-decode" class="nav-item py-5">Decode</div>
                <div onclick="switchTab('profile')" id="tab-profile" class="nav-item py-5">Profile</div>
                <div onclick="switchTab('premium')" id="tab-premium" class="nav-item py-5">Premium</div>
            </div>
            <div class="md:hidden text-[10px] text-cyan-400 animate-pulse">MATRIX LINKED</div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto p-4 mt-6">
        
        <!-- Tab: Home -->
        <section id="content-home" class="tab-content active">
            <div class="glass-card p-10 rounded-3xl text-center border-t border-l border-white/10">
                <h2 class="text-4xl font-black text-white tracking-tight">AI GUARDIAN <span class="text-cyan-400">ONLINE</span></h2>
                <p class="text-gray-400 mt-3 font-medium">Monitoring emotional synapses. Grammar logic engaged. üõ°Ô∏è</p>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-12">
                    <div class="p-8 bg-purple-900/20 rounded-2xl border border-purple-500/30">
                        <p class="text-xs text-purple-400 font-black uppercase tracking-widest">Growth Index</p>
                        <p class="text-5xl font-black text-white mt-2">82%</p>
                    </div>
                    <div class="p-8 bg-cyan-900/20 rounded-2xl border border-cyan-500/30">
                        <p class="text-xs text-cyan-400 font-black uppercase tracking-widest">Wellness Credits</p>
                        <p id="home-points" class="text-5xl font-black text-white mt-2">1250</p>
                    </div>
                    <div class="p-8 bg-blue-900/20 rounded-2xl border border-blue-500/30">
                        <p class="text-xs text-blue-400 font-black uppercase tracking-widest">Active Guardian</p>
                        <p class="text-5xl font-black text-white mt-2">EQ-v4</p>
                    </div>
                </div>

                <div class="mt-16 text-left">
                    <h3 class="text-sm font-black text-gray-500 uppercase tracking-widest mb-6 border-b border-white/5 pb-2">COMMAND CENTER</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <button onclick="switchTab('diary')" class="p-6 bg-white/5 border border-white/10 rounded-2xl flex items-center justify-between group hover:border-purple-500 transition-all">
                            <span class="font-bold text-lg group-hover:text-purple-400">Open Interactive Journal</span>
                            <span class="text-2xl group-hover:translate-x-2 transition-transform">‚ú®</span>
                        </button>
                        <button onclick="switchTab('decode')" class="p-6 bg-white/5 border border-white/10 rounded-2xl flex items-center justify-between group hover:border-cyan-500 transition-all">
                            <span class="font-bold text-lg group-hover:text-cyan-400">Matrix Decode</span>
                            <span class="text-2xl group-hover:rotate-12 transition-transform">üíé</span>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Tab: Diary Entries -->
        <section id="content-diary" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 glass-card p-8 rounded-3xl">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-black text-white tracking-tight flex items-center">
                            <span class="w-2 h-8 bg-cyan-400 mr-3"></span> INTERACTIVE JOURNAL
                        </h2>
                        <span id="typing-indicator" class="text-[8px] font-black text-gray-500 uppercase hidden">Guardian is listening...</span>
                    </div>

                    <textarea id="diary-input" rows="10" class="w-full p-6 rounded-2xl text-lg placeholder-gray-600 mb-4" placeholder="How are you feeling today, Kavibharathi? Don't worry about spelling, I'll help you fix it. ‚úçÔ∏è"></textarea>
                    
                    <div class="flex flex-wrap gap-4 mb-6">
                        <button id="process-btn" onclick="processDiary()" class="flex-1 py-4 btn-primary text-white rounded-2xl font-black text-sm uppercase tracking-widest disabled:opacity-50" disabled>
                            ANALYZE & TRANSFORM
                        </button>
                    </div>

                    <!-- AI FEEDBACK AREA -->
                    <div id="ai-feedback-panel" class="hidden space-y-6">
                        <!-- Grammar & Sentiment -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="p-4 bg-black/40 border border-white/10 rounded-xl">
                                <p class="text-[9px] font-black text-gray-500 uppercase mb-2">Detected Sentiment</p>
                                <span id="sentiment-tag" class="sentiment-badge sentiment-neutral">Analyzing...</span>
                            </div>
                            <div class="p-4 bg-black/40 border border-white/10 rounded-xl">
                                <p class="text-[9px] font-black text-gray-500 uppercase mb-2">Grammar Polished Version</p>
                                <p id="polished-text" class="text-xs text-gray-400 italic mb-2"></p>
                                <button onclick="applyGrammar()" class="text-[9px] font-black text-cyan-400 hover:underline">Apply Correction</button>
                            </div>
                        </div>

                        <!-- Guardian Feedback -->
                        <div id="ai-guardian-response" class="p-6 bg-purple-900/10 border border-purple-500/20 rounded-2xl">
                            <p class="text-[10px] font-black text-purple-400 uppercase tracking-widest mb-3">Guardian Feedback & Motivation üõ°Ô∏è</p>
                            <p id="guardian-text" class="text-gray-200 font-medium leading-relaxed"></p>
                            
                            <!-- Interactive Questions -->
                            <div id="interactive-questions" class="mt-4 pt-4 border-t border-white/5 space-y-3">
                                <p class="text-[9px] font-black text-cyan-400 uppercase">Self-Reflection Queries:</p>
                                <ul id="questions-list" class="text-xs text-gray-400 list-disc list-inside space-y-2"></ul>
                            </div>
                        </div>
                    </div>
                    
                    <div id="loading-indicator" class="mt-8 hidden flex flex-col items-center justify-center py-10 bg-black/20 rounded-2xl">
                        <div class="w-12 h-12 border-4 border-cyan-500/20 border-t-cyan-400 rounded-full animate-spin mb-4"></div>
                        <span id="loading-text" class="text-cyan-400 text-xs font-black uppercase tracking-widest">Analyzing Emotional Data...</span>
                    </div>
                </div>

                <div class="lg:col-span-1 space-y-8">
                    <div class="glass-card p-6 rounded-3xl text-center">
                        <h2 class="text-xs font-black text-gray-500 uppercase tracking-widest mb-4">Visual Manifestation</h2>
                        <div id="image-container" class="bg-black/40 aspect-square rounded-2xl flex items-center justify-center text-gray-700 border border-white/5 shadow-inner overflow-hidden">
                            <span class="text-xs font-bold uppercase italic">Awaiting Synapse...</span>
                        </div>
                        
                        <!-- NEW ACTION BUTTONS -->
                        <div id="image-actions" class="hidden mt-4 flex gap-2">
                            <button onclick="downloadDiarytoon()" class="flex-1 py-2 px-3 action-btn rounded-xl text-[10px] font-black uppercase flex items-center justify-center gap-2">
                                <span>üì•</span> Download
                            </button>
                            <button onclick="shareDiarytoon()" class="flex-1 py-2 px-3 action-btn rounded-xl text-[10px] font-black uppercase flex items-center justify-center gap-2">
                                <span>üåê</span> Share to Feed
                            </button>
                        </div>
                    </div>
                    <div class="p-6 bg-gradient-to-br from-indigo-900/40 to-black rounded-3xl border border-indigo-500/20">
                        <h4 class="text-xs font-black text-indigo-400 mb-2 uppercase italic">Why this matters?</h4>
                        <p class="text-[10px] text-gray-500 leading-relaxed">By reviewing the AI's feedback and corrected grammar, you improve your self-expression and communication while the Guardian protects your mental state.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Tab: Social Media -->
        <section id="content-social" class="tab-content">
            <div class="max-w-2xl mx-auto space-y-8 text-center py-20">
                <h2 class="text-5xl font-black text-white italic tracking-tighter opacity-20">NEURAL NETWORK FEED</h2>
                <div class="p-8 glass-card rounded-3xl border border-white/5">
                    <p class="text-gray-500 uppercase font-black tracking-widest">Your shared content will appear here in the community network.</p>
                </div>
            </div>
        </section>

        <!-- Tab: Decode Game -->
        <section id="content-decode" class="tab-content">
            <div class="max-w-2xl mx-auto glass-card p-10 rounded-3xl border-t border-l border-white/10">
                <div class="flex justify-between items-start mb-10">
                    <h2 class="text-2xl font-black text-white tracking-tighter">DECODE <span class="text-cyan-400 italic">MATRIX</span></h2>
                    <span class="px-3 py-1 bg-cyan-400 text-black text-[10px] font-black rounded-full">BOUNTY: 100 PTS</span>
                </div>
                
                <div id="decode-game-image" class="bg-black/60 aspect-square rounded-2xl flex items-center justify-center mb-10 overflow-hidden border border-white/10">
                    <div class="text-center p-8">
                        <p class="text-gray-500 text-sm font-bold uppercase italic mb-4">No Active Target</p>
                        <button onclick="switchTab('diary')" class="text-[10px] font-black text-cyan-400 border border-cyan-400 px-4 py-2 rounded-full hover:bg-cyan-400 hover:text-black transition">RECORD DIARY</button>
                    </div>
                </div>

                <div id="decoding-game" class="hidden">
                    <input type="text" id="guess-input" class="w-full p-5 rounded-2xl text-center text-xl mb-6 font-bold" placeholder="Decrypt the feeling...">
                    <button id="decode-btn" onclick="submitGuess()" class="w-full py-5 bg-gradient-to-r from-cyan-600 to-blue-600 text-white rounded-2xl font-black text-lg">
                        RUN DECODER
                    </button>
                    <div id="decode-result" class="mt-8 p-6 rounded-2xl text-center hidden"></div>
                </div>
            </div>
        </section>

        <!-- Tab: Profile -->
        <section id="content-profile" class="tab-content">
            <div class="glass-card p-10 rounded-3xl">
                <div class="flex flex-col items-center">
                    <div class="w-32 h-32 rounded-3xl bg-gradient-to-br from-indigo-600 via-purple-600 to-cyan-500 p-[2px]">
                        <div class="w-full h-full rounded-[22px] bg-black flex items-center justify-center text-4xl font-black text-white uppercase">KB</div>
                    </div>
                    <h2 class="text-3xl font-black mt-6 tracking-tighter uppercase">Kavibharathi</h2>
                    <p id="profile-auth-status" class="text-[10px] text-cyan-400 font-black tracking-widest mt-2">ACCESS GRANTED</p>
                </div>

                <div class="mt-16">
                    <h3 class="text-xs font-black text-gray-500 uppercase tracking-widest mb-8 border-b border-white/10 pb-2">HISTORY LOG</h3>
                    <div id="diary-history" class="grid grid-cols-1 md:grid-cols-2 gap-4 scroll-container">
                        <p class="text-gray-600 text-center py-10 italic col-span-full">No archives found.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Tab: Premium -->
        <section id="content-premium" class="tab-content">
            <div class="max-w-5xl mx-auto text-center">
                <h2 class="text-5xl font-black text-white italic tracking-tighter uppercase mb-2">PREMIUM <span class="text-cyan-400">EVOLUTION</span></h2>
                <p class="text-gray-400 font-medium mb-12">The future of mental wellness is immersive, robotic, and decentralized.</p>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Basic Tier -->
                    <div class="glass-card p-8 rounded-3xl border border-white/5 opacity-80 flex flex-col">
                        <h3 class="text-xl font-black uppercase text-gray-300">Guardian Free</h3>
                        <p class="text-3xl font-black mt-4">$0 <span class="text-xs text-gray-500">/ mo</span></p>
                        <ul class="mt-8 space-y-4 text-xs font-bold text-gray-500 text-left flex-grow">
                            <li>‚úî Core Interactive Diary</li>
                            <li>‚úî Grammar Polishing</li>
                            <li>‚úî 1 Generative Image / Day</li>
                        </ul>
                        <button class="mt-8 py-3 bg-white/10 text-white rounded-xl font-black uppercase text-[10px] cursor-not-allowed">Active Tier</button>
                    </div>

                    <!-- Plus Tier -->
                    <div class="glass-card p-8 rounded-3xl border-2 border-indigo-500 shadow-[0_0_30px_rgba(99,102,241,0.2)] flex flex-col relative scale-105 bg-indigo-900/5">
                        <span class="absolute -top-3 left-1/2 -translate-x-1/2 bg-indigo-500 text-black text-[9px] font-black px-4 py-1 rounded-full uppercase">Popular</span>
                        <h3 class="text-xl font-black uppercase text-indigo-400">Guardian Plus</h3>
                        <p class="text-3xl font-black mt-4 text-white">$9.99 <span class="text-xs text-gray-500">/ mo</span></p>
                        <ul class="mt-8 space-y-4 text-xs font-bold text-gray-300 text-left flex-grow">
                            <li>‚ú® **Weekly Generative Movies**: Your words become cinematic stories.</li>
                            <li>‚ú® **Blockchain Integration**: Own your emotional growth as unique NFTs.</li>
                            <li>‚ú® **Unlimited 4K Renders**: No limits on image generation.</li>
                        </ul>
                        <button class="mt-8 py-3 bg-indigo-600 text-white rounded-xl font-black uppercase text-[10px] hover:bg-indigo-500 transition">Unlock Evolution</button>
                    </div>

                    <!-- Ultimate Tier -->
                    <div class="glass-card p-8 rounded-3xl border-2 border-cyan-400 shadow-[0_0_40px_rgba(0,210,255,0.2)] flex flex-col bg-cyan-900/5">
                        <h3 class="text-xl font-black uppercase text-cyan-400">Neuro Guardian</h3>
                        <p class="text-3xl font-black mt-4 text-white">$49.99 <span class="text-xs text-gray-500">/ mo</span></p>
                        <ul class="mt-8 space-y-4 text-xs font-bold text-gray-200 text-left flex-grow">
                            <li>ü§ñ **Physical Robot Companion**: A real robot in your home connected to your AI.</li>
                            <li>ü•Ω **VR Stress Buster**: Immersive 3D worlds for trauma relief.</li>
                            <li>üéûÔ∏è **Full Documentary Feature**: Your life stories turned into professional movies.</li>
                        </ul>
                        <button class="mt-8 py-3 bg-cyan-400 text-black rounded-xl font-black uppercase text-[10px] hover:bg-cyan-300 transition shadow-[0_0_15px_rgba(0,210,255,0.4)]">Apply for Pilot</button>
                    </div>
                </div>

                <!-- Roadmap Detail Sections -->
                <div class="mt-20 grid grid-cols-1 md:grid-cols-2 gap-8 text-left">
                    <div class="glass-card p-8 rounded-3xl border-l-4 border-purple-500">
                        <h4 class="text-lg font-black text-white mb-4 uppercase italic tracking-tight">üìΩÔ∏è Cinema of the Soul</h4>
                        <p class="text-sm text-gray-400 leading-relaxed">In the coming months, your diary entries won't just be text. Our generative AI will compile your weekly achievements into **full-length cinematic stories**. Using advanced video-diffusers, we will create high-fidelity movies where you are the hero of your own growth.</p>
                    </div>
                    <div class="glass-card p-8 rounded-3xl border-l-4 border-blue-500">
                        <h4 class="text-lg font-black text-white mb-4 uppercase italic tracking-tight">‚õìÔ∏è Blockchain Neural Ledger</h4>
                        <p class="text-sm text-gray-400 leading-relaxed">Secure your legacy. We are integrating **Solana and Ethereum Layer-2** technology to store your emotional milestones as encrypted, unique tokens. Your mental wellness journey becomes a permanent, private, and decentralised record of your life.</p>
                    </div>
                    <div class="glass-card p-8 rounded-3xl border-l-4 border-cyan-400">
                        <h4 class="text-lg font-black text-white mb-4 uppercase italic tracking-tight">ü•Ω VR Stress Buster Matrix</h4>
                        <p class="text-sm text-gray-400 leading-relaxed">Step inside your mind. The **VR Stress Buster** allows you to wear an Oculus or Vision Pro and enter a virtual world generated from your happy memories. Fight stressors in a gamified 3D environment or relax in a peaceful forest built from your own positive thoughts.</p>
                    </div>
                    <div class="glass-card p-8 rounded-3xl border-l-4 border-white">
                        <h4 class="text-lg font-black text-white mb-4 uppercase italic tracking-tight">ü§ñ The Physical Guardian (Real Robot)</h4>
                        <p class="text-sm text-gray-400 leading-relaxed">Our ultimate goal: **The Diarytoon Droid**. For full-tier subscribers, we will provide an account-linked physical robot companion. It will sit on your desk, recognize your voice, listen to your problems, and react with emotional intelligence, acting as a real-world guardian near you 24/7.</p>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Bottom Status Bar -->
    <div class="fixed bottom-0 left-0 right-0 p-1 bg-black text-[8px] font-black text-cyan-400 text-center opacity-60 pointer-events-none z-[100] tracking-[0.3em] uppercase border-t border-cyan-950">
        AI Protocol: <span id="auth-status-raw">Detecting...</span> // EQ Analysis Active // Future-Ready Node: v4.0.5
    </div>

    <!-- Firebase / Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-diarytoon-app';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db, auth, currentUserId = null;
        let todayEntryRef = null;
        let lastGeneratedImageUrl = null;

        const API_KEY = ""; // Runtime Injection
        const GEMINI_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";
        const IMAGEN_URL = "https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=";

        window.switchTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('tab-active'));
            document.getElementById(`content-${tabId}`).classList.add('active');
            const tabEl = document.getElementById(`tab-${tabId}`);
            if (tabEl) tabEl.classList.add('tab-active');
            window.scrollTo(0,0);
        };

        const CONCEPTUAL_ENCRYPT = (text) => btoa(unescape(encodeURIComponent(text)));
        const CONCEPTUAL_DECRYPT = (cipher) => {
            try { return decodeURIComponent(escape(atob(cipher))); }
            catch { return "[Encrypted Content]"; }
        };

        const showMessage = (msg) => {
            const rawStatus = document.getElementById('auth-status-raw');
            rawStatus.textContent = msg;
            setTimeout(() => rawStatus.textContent = currentUserId || 'Authenticated', 5000);
        };

        const startApp = async () => {
            if (!firebaseConfig.apiKey) return;
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, user => {
                if (user) {
                    currentUserId = user.uid;
                    document.getElementById('auth-status-raw').textContent = user.uid;
                    document.getElementById('profile-auth-status').textContent = `ID: ${user.uid.substring(0,8)}...`;
                    document.getElementById('process-btn').disabled = false;
                    loadHistory();
                }
            });

            if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
            else await signInAnonymously(auth);
        };

        const loadHistory = () => {
            const q = query(collection(db, 'artifacts', appId, 'users', currentUserId, 'diary_entries'), orderBy("timestamp", "desc"));
            onSnapshot(q, snap => {
                const list = document.getElementById('diary-history');
                list.innerHTML = snap.empty ? '<p class="text-center py-10 text-gray-600 font-bold uppercase text-[10px]">No records found.</p>' : '';
                snap.forEach(docSnapshot => {
                    const data = docSnapshot.data();
                    const div = document.createElement('div');
                    div.className = "p-6 bg-white/5 border border-white/10 rounded-2xl";
                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <p class="font-black text-white text-sm tracking-tight">${data.timestamp?.toDate().toLocaleDateString() || 'LIVE'}</p>
                            <span class="text-[8px] bg-cyan-900/30 text-cyan-400 px-3 py-1 rounded-full uppercase font-black">${data.theme || 'NONE'}</span>
                        </div>
                        <p class="text-[10px] text-gray-500 font-bold italic mb-4">Cipher: "${data.guessResult || 'Pending'}"</p>
                        <details class="text-[10px]">
                            <summary class="cursor-pointer text-gray-600 font-black uppercase">Decrypt Source</summary>
                            <p class="mt-4 p-4 bg-black/40 rounded-xl text-gray-400 leading-relaxed font-medium">${CONCEPTUAL_DECRYPT(data.encryptedText)}</p>
                        </details>
                    `;
                    list.appendChild(div);
                });
            }, (error) => {
                console.error("Firestore Error:", error);
            });
        };

        // --- ENHANCED AI CALL ---
        const callAI = async (text) => {
            const prompt = `
            Analyze this diary entry: "${text}".
            Act as an Emotional Intelligence AI (EQ Guardian). 
            Tasks:
            1. Extract core non-sensitive emotional theme (1-3 words).
            2. FIX GRAMMAR AND SPELLING: Provide a corrected, "polished" version of the user's text.
            3. EMOTIONAL FEEDBACK: 
               - If user is SAD: Be highly motivational, encouraging, use supportive emojis like üõ°Ô∏è, ‚ù§Ô∏è, ‚ú®. Be a guardian.
               - If user is HAPPY: Be high-energy, encouraging them to achieve more, set a goal, use high-energy emojis like üöÄ, üî•, üèÜ.
               - If user is ANGRY: Be calming and empathetic.
            4. SENTIMENT: Classify as "Happy", "Sad", or "Neutral".
            5. INTERACTIVE QUESTIONS: Provide 2-3 deep reflection questions for the user based on their text.
            6. IMAGEN PROMPT: Create a symbolic Studio Ghibli art prompt based on the mood.

            OUTPUT JSON ONLY: {
                theme: string, 
                guardianResponse: string, 
                imagenPrompt: string, 
                polishedText: string, 
                sentiment: string, 
                interactiveQuestions: string[]
            }`;

            const res = await fetch(GEMINI_URL + API_KEY, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    contents: [{parts: [{text: prompt}]}],
                    generationConfig: { responseMimeType: "application/json" }
                })
            });
            const data = await res.json();
            return JSON.parse(data.candidates[0].content.parts[0].text);
        };

        const generateImage = async (prompt) => {
            const res = await fetch(IMAGEN_URL + API_KEY, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ instances: {prompt}, parameters: {sampleCount: 1, aspectRatio: "1:1"} })
            });
            const data = await res.json();
            return `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}`;
        };

        const scoreGuess = async (truth, guess) => {
            const res = await fetch(GEMINI_URL + API_KEY, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    contents: [{parts: [{text: `Truth: "${truth}", Guess: "${guess}". Rate similarity 0-1 and give feedback in JSON: {similarityScore: number, pointsAwarded: number, feedbackMessage: string}`}]}],
                    generationConfig: { responseMimeType: "application/json" }
                })
            });
            const data = await res.json();
            return JSON.parse(data.candidates[0].content.parts[0].text);
        };

        // --- ACTIONS ---
        window.processDiary = async () => {
            const input = document.getElementById('diary-input');
            const val = input.value.trim();
            if (val.length < 30) return showMessage("SYSTEM REQUIRES MORE DATA (30+ CHARS)");

            setLoading(true, "AI Guardian Analyzing Synapses...");
            try {
                const analysis = await callAI(val);
                
                document.getElementById('guardian-text').textContent = analysis.guardianResponse;
                document.getElementById('polished-text').textContent = analysis.polishedText;
                
                const st = document.getElementById('sentiment-tag');
                st.textContent = analysis.sentiment;
                st.className = `sentiment-badge sentiment-${analysis.sentiment.toLowerCase()}`;
                
                const qList = document.getElementById('questions-list');
                qList.innerHTML = analysis.interactiveQuestions.map(q => `<li>${q}</li>`).join('');
                
                document.getElementById('ai-feedback-panel').classList.remove('hidden');

                setLoading(true, "Rendering Stylized Manifestation...");
                const img = await generateImage(analysis.imagenPrompt);
                lastGeneratedImageUrl = img;
                
                const imgHTML = `<img src="${img}" class="w-full h-full object-cover rounded-2xl" />`;
                document.getElementById('image-container').innerHTML = imgHTML;
                document.getElementById('decode-game-image').innerHTML = imgHTML;
                document.getElementById('decoding-game').classList.remove('hidden');
                
                // Show actions (Download/Share)
                document.getElementById('image-actions').classList.remove('hidden');

                window.currentDiaryData = { text: val, theme: analysis.theme };
                window.lastPolishedText = analysis.polishedText;

                todayEntryRef = await addDoc(collection(db, 'artifacts', appId, 'users', currentUserId, 'diary_entries'), {
                    encryptedText: CONCEPTUAL_ENCRYPT(val),
                    theme: analysis.theme,
                    timestamp: serverTimestamp(),
                    sentiment: analysis.sentiment
                });

                showMessage("Transformation Complete. Review Guardian Feedback.");
            } catch (e) {
                console.error(e);
                showMessage("Transmission Error.");
            } finally {
                setLoading(false);
            }
        };

        window.applyGrammar = () => {
            if (window.lastPolishedText) {
                document.getElementById('diary-input').value = window.lastPolishedText;
                showMessage("Grammar polished text applied.");
            }
        };

        window.downloadDiarytoon = () => {
            if (!lastGeneratedImageUrl) return;
            const link = document.createElement('a');
            link.href = lastGeneratedImageUrl;
            link.download = `Diarytoon_${Date.now()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showMessage("Image Download Initialized.");
        };

        window.shareDiarytoon = () => {
            if (!lastGeneratedImageUrl) return;
            // Conceptual Share
            showMessage("Shared to Neural Social Feed! +10 Credits Earned.");
            switchTab('social');
        };

        window.submitGuess = async () => {
            const guess = document.getElementById('guess-input').value.trim();
            const btn = document.getElementById('decode-btn');
            const resEl = document.getElementById('decode-result');
            if (!guess || !window.currentDiaryData) return;

            btn.disabled = true;
            btn.textContent = "DECRYPTING...";
            try {
                const result = await scoreGuess(window.currentDiaryData.theme, guess);
                resEl.className = `mt-8 p-6 rounded-2xl text-center ${result.pointsAwarded > 50 ? 'bg-cyan-500/20 text-cyan-400' : 'bg-yellow-500/20 text-yellow-400'}`;
                resEl.innerHTML = `<p class="text-3xl font-black">üéâ +${result.pointsAwarded} CRD</p><p class="text-[10px] font-bold mt-2 uppercase tracking-widest">${result.feedbackMessage}</p>`;
                resEl.classList.remove('hidden');

                if (todayEntryRef) {
                    await setDoc(todayEntryRef, { guessResult: `${guess} (${result.pointsAwarded} pts)` }, { merge: true });
                }
            } catch (e) {
                console.error(e);
            } finally {
                btn.textContent = "DECODE COMPLETE";
            }
        };

        const setLoading = (load, msg) => {
            document.getElementById('loading-indicator').classList.toggle('hidden', !load);
            document.getElementById('loading-text').textContent = msg;
        };

        // Expose global functions
        window.downloadDiarytoon = downloadDiarytoon;
        window.shareDiarytoon = shareDiarytoon;

        startApp();
    </script>
</body>
</html>