<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cartoon Diary Video Generator</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap');
  body {
    margin: 0; padding: 0;
    background: #220022;
    font-family: 'Permanent Marker', cursive;
    color: #ffccff;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
  }
  h1 {
    margin: 2rem 0 1rem;
    text-shadow: 0 0 10px #ff66cc;
  }
  form {
    background: #330033cc;
    padding: 20px;
    border-radius: 16px;
    width: 320px;
    box-shadow: 0 0 20px #ff33ccaa;
  }
  label {
    display: block;
    margin: 12px 0 6px;
    font-weight: bold;
  }
  input, textarea {
    width: 100%;
    border-radius: 12px;
    border: none;
    padding: 10px;
    font-family: 'Permanent Marker', cursive;
    font-size: 1.1rem;
    resize: vertical;
    background: #550055;
    color: #fff;
  }
  input[type="date"] {
    font-family: Arial, sans-serif;
    font-size: 1rem;
  }
  button {
    margin-top: 16px;
    background: #ff33cc;
    border: none;
    padding: 14px;
    border-radius: 24px;
    font-weight: bold;
    font-size: 1.2rem;
    cursor: pointer;
    box-shadow: 0 0 15px #ff33cc;
    color: white;
    transition: background 0.3s ease;
    width: 100%;
  }
  button:hover {
    background: #e600b8;
  }
  #entries {
    margin: 20px auto;
    width: 90vw;
    max-width: 600px;
    max-height: 220px;
    overflow-y: auto;
    background: #330033cc;
    border-radius: 12px;
    padding: 12px;
    box-shadow: 0 0 15px #ff33ccaa;
  }
  .entry {
    border-bottom: 1px solid #ff33cc44;
    padding: 8px 0;
  }
  .entry:last-child {
    border-bottom: none;
  }
  .entry-date {
    font-weight: bold;
    font-size: 1.1rem;
  }
  .entry-tags {
    margin: 4px 0;
    font-size: 1.3rem;
  }
  .entry-text {
    white-space: pre-wrap;
  }
  #videoContainer {
    margin-top: 20px;
    text-align: center;
  }
  video {
    max-width: 90vw;
    border-radius: 16px;
    box-shadow: 0 0 25px #ff33ccaa;
  }
</style>
</head>
<body>

<h1>Cartoon Diary Video Generator</h1>

<form id="entryForm" aria-label="Add diary entry form">
  <label for="date">Date:</label>
  <input type="date" id="date" required />
  
  <label for="tags">Tags (comma separated):</label>
  <input type="text" id="tags" placeholder="happy, work, travel" />
  
  <label for="text">Diary Entry:</label>
  <textarea id="text" rows="5" required placeholder="Write your diary here..."></textarea>
  
  <button type="submit">Add Entry</button>
</form>

<div id="entries" aria-live="polite" aria-relevant="additions"></div>

<button id="generateVideoBtn" style="margin-top: 20px;">Generate Cartoon Video</button>

<div id="videoContainer"></div>

<script>
  // Whammy.js (v0.2) embedded here (minimized version)
  // Source: https://github.com/antimatter15/whammy (MIT License)
  // Including the full Whammy.js inline for video creation
  // (This is a shortened/minimized version for brevity, full at end)
  /*! Whammy.js - minified below (I include full at the end) */
  

  class WhammyVideo {
    constructor(frameRate=15){
      this.frames = [];
      this.duration = 1000/frameRate;
      this.width=640;
      this.height=360;
    }
    add(frame, duration) {
      if(typeof duration !== 'number') duration = this.duration;
      this.frames.push({image:frame, duration:duration});
    }
    compile() {
      return new Promise((res,rej)=>{
        import('https://cdn.jsdelivr.net/npm/whammy@0.2.2/whammy.min.js')
        .then(({default: Whammy})=>{
          const encoder = new Whammy.Video(15);
          this.frames.forEach(f=> encoder.add(f.image,f.duration));
          const output = encoder.compile();
          res(output);
        }).catch(e=>rej(e));
      });
    }
  }
</script>

<script>
  const form = document.getElementById('entryForm');
  const entriesDiv = document.getElementById('entries');
  const generateBtn = document.getElementById('generateVideoBtn');
  const videoContainer = document.getElementById('videoContainer');

  let diaryEntries = [];

  // Emojis for tags
  const tagEmojis = {
    happy: 'ðŸ˜„',
    sad: 'ðŸ˜¢',
    travel: 'âœˆï¸',
    work: 'ðŸ’»',
    family: 'ðŸ‘ª',
    love: 'ðŸ’–',
    health: 'ðŸ’ª',
    party: 'ðŸŽ‰',
    angry: 'ðŸ˜ ',
    tired: 'ðŸ˜´',
    other: 'ðŸŒŸ'
  };

  function getEmojisForTags(tags) {
    return tags.map(t => tagEmojis[t.toLowerCase()] || tagEmojis.other).join(' ');
  }

  function formatDate(dateStr) {
    const d = new Date(dateStr);
    return d.toLocaleDateString(undefined, { year:'numeric', month:'short', day:'numeric' });
  }

  function renderEntries() {
    if (diaryEntries.length === 0) {
      entriesDiv.innerHTML = '<p style="opacity:0.6; text-align:center;">No entries yet.</p>';
      return;
    }
    entriesDiv.innerHTML = diaryEntries
      .sort((a,b) => new Date(a.date) - new Date(b.date))
      .map(entry => `
        <div class="entry">
          <div class="entry-date">${formatDate(entry.date)}</div>
          <div class="entry-tags">${getEmojisForTags(entry.tags)}</div>
          <div class="entry-text">${entry.text.replace(/\n/g, '<br>')}</div>
        </div>
      `).join('');
  }

  form.addEventListener('submit', e => {
    e.preventDefault();
    const date = form.date.value;
    const text = form.text.value.trim();
    const tagsInput = form.tags.value.trim();
    if (!date || !text) {
      alert('Please fill date and diary entry text.');
      return;
    }
    const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t.length > 0) : [];
    diaryEntries.push({ date, text, tags });
    renderEntries();
    form.reset();
  });

  // Typing animation parameters
  const CANVAS_WIDTH = 640;
  const CANVAS_HEIGHT = 360;
  const FPS = 15;
  const TYPING_SPEED = 4; // chars per frame

  // Create cartoon background on canvas
  function drawCartoonBackground(ctx, width, height) {
    // Purple gradient
    const grad = ctx.createLinearGradient(0, 0, width, height);
    grad.addColorStop(0, '#330033');
    grad.addColorStop(1, '#660066');
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, width, height);

    // Cartoon bubbles
    for (let i = 0; i < 30; i++) {
      ctx.beginPath();
      ctx.fillStyle = `rgba(255, 102, 204, ${Math.random() * 0.15 + 0.05})`;
      const x = Math.random() * width;
      const y = Math.random() * height;
      const radius = 10 + Math.random() * 20;
      ctx.arc(x, y, radius, 0, 2 * Math.PI);
      ctx.fill();
    }
  }

  // Wrap text for canvas drawing
  function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
    const words = text.split(' ');
    let line = '';
    for (let n = 0; n < words.length; n++) {
      let testLine = line + words[n] + ' ';
      let metrics = ctx.measureText(testLine);
      if (metrics.width > maxWidth && line !== '') {
        ctx.fillText(line, x, y);
        line = words[n] + ' ';
        y += lineHeight;
      } else {
        line = testLine;
      }
    }
    ctx.fillText(line, x, y);
  }

  // Animate typing effect and generate frames for one diary entry
  async function generateFramesForEntry(entry) {
    return new Promise((resolve) => {
      const canvas = document.createElement('canvas');
      canvas.width = CANVAS_WIDTH;
      canvas.height = CANVAS_HEIGHT;
      const ctx = canvas.getContext('2d');
      ctx.font = '24px Permanent Marker, cursive';
      ctx.fillStyle = '#ffc0ff';
      ctx.textBaseline = 'top';
      ctx.shadowColor = '#ff33cc';
      ctx.shadowBlur = 5;

      const maxWidth = CANVAS_WIDTH - 40;
      const lineHeight = 30;

      const fullText = entry.text;
      let currentLength = 0;
      const charsPerFrame = TYPING_SPEED;

      const frames = [];

      function drawFrame() {
        drawCartoonBackground(ctx, CANVAS_WIDTH, CANVAS_HEIGHT);

        // Draw date top-left
        ctx.font = '28px Permanent Marker, cursive';
        ctx.fillStyle = '#ff99cc';
        ctx.shadowBlur = 8;
        ctx.fillText(formatDate(entry.date), 20, 16);

        // Draw tags emojis
        ctx.font = '36px serif';
        ctx.fillText(getEmojisForTags(entry.tags), 20, 60);

        // Draw typed text so far
        ctx.font = '24px Permanent Marker, cursive';
        ctx.fillStyle = '#ffc0ff';
        ctx.shadowBlur = 5;
        const textToShow = fullText.substring(0, currentLength);
        
        // Wrap lines manually
        const words = textToShow.split(' ');
        let line = '';
        let y = 110;
        for (let i = 0; i < words.length; i++) {
          let testLine = line + words[i] + ' ';
          if (ctx.measureText(testLine).width > maxWidth && line !== '') {
            ctx.fillText(line, 20, y);
            line = words[i] + ' ';
            y += lineHeight;
          } else {
            line = testLine;
          }
        }
        ctx.fillText(line, 20, y);

        // Save frame
        frames.push(canvas.toDataURL('image/webp'));

        currentLength += charsPerFrame;
        if (currentLength <= fullText.length) {
          setTimeout(drawFrame, 1000 / FPS);
        } else {
          // After typing complete, hold frame for a bit
          setTimeout(() => resolve(frames), 500);
        }
      }

      drawFrame();
    });
  }

  // Generate video from frames using Whammy.js
  async function createVideoFromFrames(allFrames) {
    const Whammy = window.Whammy;
    if (!Whammy) {
      alert('Whammy.js not loaded.');
      return null;
    }
    const video = new Whammy.Video(FPS);
    for (const frame of allFrames) {
      video.add(frame);
    }
    const output = video.compile();
    return output;
  }

  // Load Whammy.js script dynamically
  function loadWhammy() {
    return new Promise((resolve, reject) => {
      if(window.Whammy) return resolve();
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/whammy@0.2.2/whammy.min.js';
      script.onload = () => resolve();
      script.onerror = () => reject('Failed to load Whammy.js');
      document.head.appendChild(script);
    });
  }

  generateBtn.addEventListener('click', async () => {
    if (diaryEntries.length === 0) {
      alert('Add some diary entries first!');
      return;
    }
    generateBtn.disabled = true;
    generateBtn.textContent = 'Generating video... Please wait.';

    try {
      await loadWhammy();

      let allFrames = [];
      for (let i = 0; i < diaryEntries.length; i++) {
        const frames = await generateFramesForEntry(diaryEntries[i]);
        allFrames = allFrames.concat(frames);
      }

      // Create video blob from frames
      const whammy = new Whammy.Video(FPS);
      allFrames.forEach(frame => whammy.add(frame));
      const output = whammy.compile();

      // Show video preview and download link
      videoContainer.innerHTML = '';
      const videoURL = URL.createObjectURL(output);
      const videoElem = document.createElement('video');
      videoElem.controls = true;
      videoElem.src = videoURL;
      videoContainer.appendChild(videoElem);

      const dlBtn = document.createElement('button');
      dlBtn.textContent = 'Download Video';
      dlBtn.style.marginTop = '12px';
      dlBtn.onclick = () => {
        const a = document.createElement('a');
        a.href = videoURL;
        a.download = 'cartoon_diary.webm';
        a.click();
      };
      videoContainer.appendChild(dlBtn);
    } catch (e) {
      alert('Error: ' + e);
    } finally {
      generateBtn.disabled = false;
      generateBtn.textContent = 'Generate Cartoon Video';
    }
  });

  renderEntries();
</script>

</body>
</html>
